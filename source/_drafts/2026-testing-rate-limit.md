---
title: 測試 Rate Limit 就像在測金庸小說的「斗轉星移」
date: 2026-01-30 21:30:00
tags:
  - Rate Limit 測試
  - 軟體測試
---

第一次在公司裡面測試 Rate Limit 的功能，這個機會不多，所以趁這個時機寫點紀錄

之前做過的壓力測試，主要都是為了量測系統是否能夠在某個 RPS/RPM(Request Per Second/Request Per Minute) 下正常運作
也會確保把機器打爆之後，將 RPS/RPM 歸零或設為小流量，確認機器是否能夠恢復正常

但是 Rate Limit 的測試就有一些的不同，他是測試 Rate Limit 是否會被觸發
所以比較會是功能測試，但會需要用到壓力測試的工具

有些人的想法或許會比較單純的認為
「啊就把 RPS/RPM 直接壓爛，看有沒有回 429 就好啦~」
但實際上還是有蠻多的測試點可以做思考，所以寫出來記錄一下，畢竟這個機會也算是蠻難得的吧 🤩

先簡單描述一下這一次的 Rate Limit 功能

1. 未設定 RPS/RPM 的店家，都會走全域的 RPS/RPM，且不被共用（意思是指，全域 RPS/RPM 為 10/600 時，A 店家跟 B 店家被 Call RPS/RPM (8/480) 時，不會回應 429）
2. 可以針對店家設定屬於該店家的 RPS/RPM
3. 設定的地方在 Redis，所以預期改動設定會立即套用
4. 當觸發 RPS/RPM 時，會開始回應 429

## 針對功能進行測試的發想

### 測試前提

在發想前，為了避免過於發散，所以會先設一下 outline

1. 全域設定是必然存在的
2. 不需要「順便」測試系統負載，以 Rate Limit 的驗證為優先
3. 假設 Redis 連線正常，不測試 Redis 故障情況，聚焦在 Rate Limit 觸發邏輯本身

不過實務上還是會針對範圍以外的內容進行風險確認，畢竟 Redis 壞掉或者 Config 遺失的風險也還是可能存在的
就會確認這種狀態底下，是否會發生哪些問題(這個就會丟給開發者去做確認)

### 開始發想

先簡單暴力的確認全域的 RPS/RPM 可不可以正常運作，這樣做會引發一個思考

> 如何確保被觸發的是 RPS 或 RPM?

自我解答：就是把其中一個數字設定得很大，實際模擬 RPS/RPM 時，確保不會觸發到即可
但又冒出了一個問題

> 如何在「還不確定 Config 是否正常運作」的情況下，驗證 RPS/RPM 設定確實有效？

再次自我解答：那就是先把兩個數字都設得很大，確保小流量不會回應 429，至少我能確認小流量的情況下系統正常運作了
確保 RPS/RPM 皆正常運作之後，再把其中一個數字設定為 1，這樣我手動就能觸發 429 確保 Rate Limit 機制正常運作了

經過上面的思考之後，我們可以得到以下測試想法

```
A. 全域設定驗證
  1. 全域 RPS 限制是否正常觸發
  2. 全域 RPM 限制是否正常觸發
B. 店家設定驗證
  1. 店家專屬 RPS 限制是否正常觸發
  2. 店家專屬 RPM 限制是否正常觸發
C. 設定優先權驗證
  1. 當店家有專屬設定時，是否優先使用店家設定而非全域設定
  2. 當店家無專屬設定時，是否正確 fallback 到全域設定
D. 回應驗證
  1. 觸發限制時，是否正確回應 HTTP 429 (Too Many Requests)
  2. 未觸發限制時,是否正常回應 HTTP 200
E. 即時更新驗證
  1. 修改 Redis 設定後，是否立即生效（不需重啟服務）
  2. 當實際 call 的 RPS 降低後，系統是否能夠恢復正常
F. 其他
  1. 確保店家專屬設定不會套用在其他店家
  2. 確保全域設定不被店家共用
```

### 實際執行的測試情境

當全域 RPS 設定為 20, 全域 RPM 設定為 3600

1. 用 RPS: 19，Call A 店家，預期所有 response 為 200
2. 用 RPS: 21，Call A 店家，預期因為觸發全域 RPS 而得到 429 response
3. a,b 執行完之後，維持 Call A 店家 RPS: 21，更改全域 RPS 為 25，預期不再得到 429
4. c 執行完之後，維持 Call A 店家 RPS: 21，更改全域 RPM 為 1080，預期因為觸發全域 RPM 而得到 429 response（因為 RPS: 21 的 RPM 為 1260）
5. 繼續使用 RPS: 21 Call A 店家，設定 A 店家的專屬 Config: 22/1500(RPS/RPM)，預期不再得到 429
此時的全域 RPS/RPM 為 25/1080
6. ...

第 1 個測試是直接確認單一店家正常流量的狀態是否能夠正常運作
第 2 個測試是直接全域 RPS Config 是否可以正常運作
第 3 個測試是確認全域 RPS Config 更新後是否能夠即時套用
第 4 個測試是確認全域 RPM Config 是否可以正常運作
第 5 個測試是確認店家專屬的 Config 設定後，店家在正常流量下是否能夠正常運作，且不會套用全域 Config
...


你要同時顧及兩個 config 同時存在時，要套用的是 global 還是 specific 的 config
model:
單一存在，僅 global 會有的情境
兩者存在，global + specific config

## 結語
