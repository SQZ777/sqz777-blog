<!DOCTYPE html><html class="appearance-auto" lang="zh-TW"><head><meta charset="UTF-8"><title>Playwright 攔截 request 簡易筆記和範例 - sqz777's blog</title><meta name="description" content="工作上測試遇到了一個情境是測試 Web SDK，主要類似於 GA 的那種監控網頁事件來發送 request 的受測對象Web SDK 會根據當下使用者的事件觸發順序而產生不同的 request 內容今天準備了一個可以觸發 request 的 HTML、接收 request 的簡單 Node.js.."><meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, initial-scale=1"><meta name="image" content="https://blogs.sqz777.com/img/2024-easy-playwright-intercept-note/1.png"><meta name="original-source" content="https://blogs.sqz777.com/2024/09/08/2024-easy-playwright-intercept-note/"><link rel="canonical" href="https://blogs.sqz777.com/2024/09/08/2024-easy-playwright-intercept-note/"><meta property="og:locale" content="zh-TW"><meta property="og:type" content="article"><meta property="og:title" content="Playwright 攔截 request 簡易筆記和範例 - sqz777's blog"><meta property="og:description" content="工作上測試遇到了一個情境是測試 Web SDK，主要類似於 GA 的那種監控網頁事件來發送 request 的受測對象Web SDK 會根據當下使用者的事件觸發順序而產生不同的 request 內容今天準備了一個可以觸發 request 的 HTML、接收 request 的簡單 Node.js.."><meta property="og:url" content="https://blogs.sqz777.com/2024/09/08/2024-easy-playwright-intercept-note/"><meta property="og:site_name" content="SQZ777's blog"><meta property="og:image" content="https://blogs.sqz777.com/img/2024-easy-playwright-intercept-note/1.png"><meta property="fb:app_id" content="000000000000000"><meta name="twitter:title" content="Playwright 攔截 request 簡易筆記和範例 - sqz777's blog"><meta name="twitter:image" content="https://blogs.sqz777.com/img/2024-easy-playwright-intercept-note/1.png"><meta name="twitter:description" content="工作上測試遇到了一個情境是測試 Web SDK，主要類似於 GA 的那種監控網頁事件來發送 request 的受測對象Web SDK 會根據當下使用者的事件觸發順序而產生不同的 request 內容今天準備了一個可以觸發 request 的 HTML、接收 request 的簡單 Node.js.."><meta name="twitter:card" content="summary_large_image"><meta name="google-site-verification" content="lTAMT4U8v-CtkYRIo8AmGaACB3EikdUYpiTHAylwGPE"><!-- Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-4N118JY08V"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-4N118JY08V');</script><!-- End Google Analytics --><link rel="icon" href="/images/favicon.ico"><link rel="stylesheet" href="/style/common/bulma.css"><link rel="stylesheet" href="/style/base.css"><link rel="stylesheet" href="/style/common/helper.css"><script src="/js/common.js"></script><link rel="stylesheet" href="/style/post.css"><link rel="stylesheet" href="/style/themes/highlight-theme-light.css"><link rel="stylesheet" href="/style/common/jquery.fancybox.min.css"><script src="/js/highlight.pack.js"></script><meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="/atom.xml" title="SQZ777's blog" type="application/atom+xml">
</head><body class="is-flex is-flex-direction-column"><header class="header-widget is-flex-shrink-0 is-hidden-mobile"><div class="container is-fullhd is-flex is-justify-content-space-between is-align-items-center is-full-height"><section class="is-hidden-mobile is-flex-shrink-0"><h2><a href="/">sqz777's blog</a></h2></section><h3 class="is-hidden-mobile is-family-serif is-full-height is-flex is-align-items-center is-flex-shrink-0"><div class="is-full-height" id="postTopic"><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">Playwright 攔截 request 簡易筆記和範例</p><p class="is-full-height is-flex-shrink-0 is-flex is-align-items-center is-justify-content-center">點擊返回開頭</p></div></h3><aside class="is-flex-shrink-0"><h3 class="is-inline-block"><a href="/">首頁</a></h3><h3 class="is-inline-block"><a href="/about">關於我</a></h3><h3 class="is-inline-block"><a href="/archives">文章列表</a></h3></aside></div></header><header class="is-flex header-widget is-flex-shrink-0 is-align-items-center is-justify-content-center is-hidden-tablet"><h3 class="is-inline-block"><a href="/">首頁</a></h3><h3 class="is-inline-block"><a href="/about">關於我</a></h3><h3 class="is-inline-block"><a href="/archives">文章列表</a></h3></header><main><main class="container is-max-widescreen content section post-page pt-4 px-4"><div class="columns is-flex-desktop is-justify-content-center is-flex-direction-row-reverse"><div class="column is-3 is-hidden-mobile"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="toc-text">程式碼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Playwright-%E6%94%94%E6%88%AA%E7%AF%84%E4%BE%8B"><span class="toc-text">Playwright 攔截範例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A1%8D%E5%A4%96%E7%AD%86%E8%A8%98"><span class="toc-text">額外筆記</span></a></li></ol></div><div class="column is-9"><header class="my-4"><a href="/tags/Playwright"><i class="tag post-item-tag">Playwright</i></a><a href="/tags/%E6%94%94%E6%88%AARequest"><i class="tag post-item-tag">攔截Request</i></a></header><h1 class="mt-0 mb-1 is-family-serif" id="postTitle">Playwright 攔截 request 簡易筆記和範例</h1><time class="has-text-grey" datetime="2024-09-08T16:18:00.000Z">2024-09-08</time><article class="mt-2 post-content"><p>工作上測試遇到了一個情境是測試 Web SDK，主要類似於 GA 的那種監控網頁事件來發送 request 的受測對象<br>Web SDK 會根據當下使用者的事件觸發順序而產生不同的 request 內容<br>今天準備了一個可以觸發 request 的 HTML、接收 request 的簡單 Node.js Backend API Server<br>還有筆記用的 Playwright 攔截 request 範例程式碼</p>
<p>所有程式碼都放在這: <a target="_blank" rel="noopener" href="https://github.com/SQZ777/playwright-intercept-example">範例程式碼</a></p>
<p>這張圖應該能表達到今天文章範例中的攔截器概念(?)</p>
<p><img src="/../img/2024-easy-playwright-intercept-note/1.png" alt="interceptor_meme"></p>
<p>自動化的執行流程:</p>
<ol>
<li>啟動 server.js，讓 html 可以透過本地伺服器瀏覽</li>
<li>使用瀏覽器瀏覽 localhost:3000</li>
<li>點擊按鈕觸發 request 發送的動作</li>
<li>攔截 request 驗證 request 被發送的正確性</li>
</ol>
<h2 id="程式碼"><a href="#程式碼" class="headerlink" title="程式碼"></a>程式碼</h2><p><del>可能不算程式碼…? 沒有人:可是它裡面有 js</del></p>
<p>此 HTML 會在按下按鈕後擷取當下瀏覽器中的 timezone，將 timezone 夾帶進去 request 發送到 Backend Server</p>
<pre><code class="HTML">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;

&lt;head&gt;
    &lt;meta charset=&quot;UTF-8&quot;&gt;
    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;
    &lt;title&gt;Playwright Example&lt;/title&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;h1&gt;Playwright Intercept Request Example&lt;/h1&gt;
    &lt;button id=&quot;sendRequest&quot;&gt;Send Request&lt;/button&gt;

    &lt;script&gt;
        const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        document.getElementById(&#39;sendRequest&#39;).addEventListener(&#39;click&#39;, () =&gt; &#123;
            fetch(&#39;/api/data&#39;, &#123;
                method: &#39;POST&#39;,
                headers: &#123;
                    &#39;Content-Type&#39;: &#39;application/json&#39;
                &#125;,
                body: JSON.stringify(&#123; location: timezone &#125;)
            &#125;)
                .then(response =&gt; response.json())
                .then(data =&gt; console.log(&#39;Response from server:&#39;, data))
                .catch(error =&gt; console.error(&#39;Error:&#39;, error));
        &#125;);
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre>
<p>接收 request 以及讓 HTML 可以被瀏覽</p>
<p>Node.js Server</p>
<pre><code>const express = require(&#39;express&#39;);
const path = require(&#39;path&#39;);
const app = express();
const port = 3000;

app.use(express.json());

// 提供 public 資料夾中的靜態檔案
app.use(express.static(path.join(__dirname, &#39;public&#39;)));

app.post(&#39;/api/data&#39;, (req, res) =&gt; &#123;
    console.log(&#39;Received data:&#39;, req.body);
    res.json(&#123; message: &#39;Data received successfully&#39;, receivedData: req.body &#125;);
&#125;);

// 服務 index.html
app.get(&#39;/&#39;, (req, res) =&gt; &#123;
    res.sendFile(path.join(__dirname, &#39;index.html&#39;));
&#125;);

app.listen(port, () =&gt; &#123;
    console.log(`Server is running on http://localhost:$&#123;port&#125;`);
&#125;);
</code></pre>
<h2 id="Playwright-攔截範例"><a href="#Playwright-攔截範例" class="headerlink" title="Playwright 攔截範例"></a>Playwright 攔截範例</h2><p>先寫一個不改變瀏覽器 timezone 的案例，瀏覽器會依照使用者當前的機器設定來設定 timezone<br>我目前待在台灣，所以 timezone id 會是 <code>Asia/Taipei</code></p>
<pre><code class="javascript">const &#123; test, expect &#125; = require(&#39;@playwright/test&#39;);

test.describe(&#39;test with local and no change&#39;, () =&gt; &#123;
    test(&#39;test intercept request for no change&#39;, async (&#123; page &#125;) =&gt; &#123;
        await page.route(&#39;**/api/data&#39;, (route, request) =&gt; &#123;
            console.log(&#39;Intercepted request:&#39;, request.postData());
            const postData = JSON.parse(request.postData());
            expect(postData.location).toBe(&#39;Asia/Taipei&#39;);
            route.continue();
        &#125;);
    
        await page.goto(&#39;http://localhost:3000&#39;);
        await page.click(&#39;#sendRequest&#39;);
    
        // 讓時間留給網頁處理請求
        await page.waitForTimeout(1000);
    &#125;);
&#125;);
</code></pre>
<p>再寫一個改變瀏覽器 timezone 的案例，這個案例會先將 timezone 改為 <code>Europe/Paris</code>，再執行瀏覽 HTML 的動作</p>
<pre><code class="javascript">test.describe(&#39;test with franch&#39;, () =&gt; &#123;
    test.use(&#123; timezoneId: &#39;Europe/Paris&#39; &#125;);
    test(&#39;test intercept request for no change&#39;, async (&#123; page &#125;) =&gt; &#123;
        await page.route(&#39;**/api/data&#39;, (route, request) =&gt; &#123;
            console.log(&#39;Intercepted request:&#39;, request.postData());
            const postData = JSON.parse(request.postData());
            expect(postData.location).toBe(&#39;Europe/Paris&#39;);
            route.continue();
        &#125;);
    
        await page.goto(&#39;http://localhost:3000&#39;);
        await page.click(&#39;#sendRequest&#39;);
    
        // 讓時間留給網頁處理請求
        await page.waitForTimeout(1000);
    &#125;);
&#125;);
</code></pre>
<p>兩個案例執行完之後在 console 中可以見到以下結果</p>
<p><img src="/../img/2024-easy-playwright-intercept-note/2.png" alt="playwright_result"></p>
<h2 id="額外筆記"><a href="#額外筆記" class="headerlink" title="額外筆記"></a>額外筆記</h2><p>因為這一種會持續監聽瀏覽器事件的 Web SDK，是不會有 request 停止的一刻，所以選擇使用的是 <code>page.waitForTimeout(1000)</code><br>而非 <code>page.waitForLoadState(&#39;networkidle&#39;)</code></p>
</article><section class="jump-container is-flex is-justify-content-space-between my-6"><!-- em is empty placeholder--><em></em><a class="button is-default" href="/2024/06/18/2024-init-postgres-when-materialized-view-depends-on-remote-table/" title="Dockerfile x Postgres：Materialized View 的 REFRESH 奇幻（？）之旅！"><span class="has-text-weight-semibold">下一頁: Dockerfile x Postgres：Materialized View 的 REFRESH 奇幻（？）之旅！</span><i class="iconfont icon-next ml-2 has-text-grey"></i></a></section><article class="mt-6 comment-container"><script async repo="SQZ777/sqz777-blog" src="https://utteranc.es/client.js" issue-term="title" theme="preferred-color-scheme"></script></article></div></div></main></main><footer class="is-flex is-flex-direction-column is-align-items-center is-flex-shrink-0 is-family-serif"><section class="sns-container"><!-- Github--><a title="github" target="_blank" rel="noopener nofollow" href="//github.com/sqz777"><i class="iconfont icon-github"></i></a><!-- Ins--><!-- RSS--><!-- 知乎--><!-- 领英--><!-- 脸书--></section><p><span>Copyright ©</span><span> sqz777 2024</span></p><div class="is-flex is-justify-content-center is-flex-wrap-wrap"><p>Powered by Hexo &verbar;&nbsp;</p><p class="is-flex is-justify-content-center"><a title="Hexo theme author" target="_blank" rel="noopener" href="//github.com/haojen">Theme by Haojen&nbsp;</a></p><div style="margin-top: 2px"><a class="github-button" title="github-button" target="_blank" rel="noopener" href="https://github.com/haojen/hexo-theme-Claudia" data-color-scheme="no-preference: light; light: light; dark: dark;" data-show-count="true"></a></div></div><div><span></span></div></footer><script async defer src="https://buttons.github.io/buttons.js"></script><script src="/js/jquery-3.6.1.min.js"></script><script src="/js/jquery-fancybox.min.js"></script><script src="/js/img_zoom.js"></script><script src="/js/post.js"></script></body></html>